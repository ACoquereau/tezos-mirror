# We use `scripts/run-tezt-tests-ci.sh` to split the Tezt tests into ranges:

.tezt_template:
  extends: .integration_template
  artifacts:
    paths:
      - tezt.log
    expire_in: 1 day
    when: on_failure

# this section is updated using the script scripts/update_tezt_test.sh
##BEGIN_TEZTTEST##
tezt:1:
  extends: .tezt_template
  script:
    - 'dune exec tezt/tests/main.exe -- --color --log-buffer-size 5000 --log-file tezt.log --global-timeout 3300 --time --test ''Edo: current encoding regression test: level'' --test ''Alpha: alpha encoding regression test: level'' --test ''Alpha: alpha encoding regression test: operation.raw'' --test ''Alpha: alpha encoding regression test: seed'' --test ''Edo: current encoding regression test: seed'' --test ''Alpha: alpha encoding regression test: timestamp'' --test ''Edo: current encoding regression test: fitness'' --test ''Edo: current encoding regression test: block_header'' --test ''Edo: current encoding regression test: block_header.raw'' --test ''Alpha: alpha encoding regression test: nonce'' --test ''Edo: current encoding regression test: period'' --test ''Edo: current encoding regression test: cycle'' --test ''Edo: current encoding regression test: gas.cost'' --test ''Edo: current encoding regression test: voting_period'' --test ''Alpha: alpha encoding regression test: period'' --test ''Edo: current encoding regression test: vote.ballot'' --test ''Alpha: alpha encoding regression test: gas'' --test ''Alpha: alpha encoding regression test: voting_period.kind'' --test ''Alpha: (Mockup) Transfer same participants (asynchronous)'' --test ''Edo: (Mockup) Transfer same participants (asynchronous)'' --test ''Alpha: normalize data (mockup)'' --test ''Edo: current encoding regression test: operation.internal'' --test ''Alpha: (Mockup) origination fees from unrevealed'' --test ''Alpha: alpha encoding regression test: receipt.balance_updates'' --test ''Alpha: hash data ... of type ... (bad)'' --test ''Edo: (Proxy) (/chains/main/blocks/head/helpers/current_level) Cache at most once'' --test ''Edo: (Proxy) (/chains/main/blocks/head/context/nonces/3) Cache at most once'' --test ''(Mockup) Migration (transfer)'' --test ''Alpha: (Proxy) (/chains/main/blocks/head/context/delegates) Cache at most once'' --test ''Alpha: (Proxy) (/chains/main/blocks/head/votes/successor_period) No useless RPC call'' --test ''Alpha: (Proxy) (/chains/main/blocks/head/votes/current_proposal) Cache at most once'' --test ''Alpha: (Proxy) (/chains/main/blocks/head/votes/proposals) Cache at most once'' --test ''Alpha: (Proxy) (/chains/main/blocks/head/votes/ballots) No useless RPC call'' --test ''Edo: (Proxy) (/chains/main/blocks/head/votes/listings) No useless RPC call'' --test ''Edo: (Proxy) (/chains/main/blocks/head/votes/successor_period) Cache at most once'' --test ''Alpha: (Proxy) (/chains/main/blocks/head/minimal_valid_time) Cache at most once'' --test ''Alpha: normalize data'' --test ''Alpha: (Proxy) (/chains/main/blocks/head/votes/current_period) Cache at most once'' --test ''Edo: (Proxy) Wrong proto'' --test ''Alpha: (Proxy) (/chains/main/blocks/head/helpers/baking_rights) No useless RPC call'' --test ''Edo: (Proxy) (/chains/main/blocks/head/votes/ballot_list) No useless RPC call'' --test ''Edo: (Proxy) (/chains/main/blocks/head/votes/listings) Cache at most once'' --test ''Alpha: (Proxy) (/chains/main/blocks/head/votes/ballots) Cache at most once'' --test ''Edo: (Proxy) (/chains/main/blocks/head/votes/ballot_list) Cache at most once'' --test ''Edo: current encoding regression test: operation.unsigned'' --test ''Alpha: (Proxy) (/chains/main/blocks/head/votes/successor_period) Cache at most once'' --test ''Edo: (Proxy) (/chains/main/blocks/head/helpers/baking_rights?all=true) No useless RPC call'' --test ''Alpha: (Proxy) (/chains/main/blocks/head/context/delegates) No useless RPC call'' --test ''Edo: (Proxy) (/chains/main/blocks/head/votes/ballots) Cache at most once'' --test ''Alpha: (Proxy) (/chains/main/blocks/head/votes/listings) Cache at most once'' --test ''Edo: (Proxy) (/chains/main/blocks/head/helpers/baking_rights) Cache at most once'' --test ''Alpha: alpha (mode client) RPC regression tests: others'' --test ''Alpha: alpha encoding regression test: operation'' --test ''Alpha: (Proxy) (/chains/main/blocks/head/votes/proposals) No useless RPC call'' --test ''Alpha: node initialization (full mode)'' --test ''Edo: (Proxy) Bake'' --test ''Alpha: alpha (mode client) RPC regression tests: delegates'' --test ''Alpha: alpha (mode proxy) RPC regression tests: delegates'' --test ''Edo: current (mode client) RPC regression tests: votes'' --test ''Alpha: baking ordering'' --test ''Edo: (Proxy) Compare RPC get'' --test ''tezos-codec dump encodings'' --test ''Alpha: alpha (mode proxy) RPC regression tests: contracts'' --test ''Alpha: (Mockup) Multi transfer/multi baking (asynchronous)'' --test ''Alpha: node synchronization (rolling / full)'' --test ''Alpha: node synchronization (archive / archive)'' --test ''Alpha: node synchronization (full / full)'' # 304.566508055s'

tezt:2:
  extends: .tezt_template
  script:
    - 'dune exec tezt/tests/main.exe -- --color --log-buffer-size 5000 --log-file tezt.log --global-timeout 3300 --time --test ''Alpha: alpha encoding regression test: delegate.frozen_balance'' --test ''Edo: current encoding regression test: nonce'' --test ''Alpha: alpha encoding regression test: fitness'' --test ''Alpha: alpha encoding regression test: vote.ballots'' --test ''Alpha: alpha encoding regression test: block_header'' --test ''Edo: current encoding regression test: vote.ballots'' --test ''Alpha: alpha encoding regression test: block_header.raw'' --test ''Edo: current encoding regression test: timestamp'' --test ''Edo: current encoding regression test: contract'' --test ''Alpha: alpha encoding regression test: cycle'' --test ''Alpha: alpha encoding regression test: raw_level'' --test ''Alpha: alpha encoding regression test: tez'' --test ''Alpha: alpha encoding regression test: gas.cost'' --test ''Alpha: alpha encoding regression test: contract'' --test ''Alpha: (Mockup) RPC header/shell'' --test ''Alpha: alpha encoding regression test: vote.ballot'' --test ''Edo: current encoding regression test: voting_period.kind'' --test ''Alpha: alpha encoding regression test: contract.big_map_diff'' --test ''Edo: current encoding regression test: delegate.balance_updates'' --test ''Alpha: (Mockup) Transfer (asynchronous)'' --test ''Alpha: alpha encoding regression test: operation.internal'' --test ''CLI under connections cap'' --test ''Edo: (Mockup) Transfer'' --test ''Alpha: (Mockup) Transfer'' --test ''Alpha: (Proxy) (/chains/main/blocks/head/helpers/current_level) Cache at most once'' --test ''Edo: (Proxy) (/chains/main/blocks/head/votes/current_period_kind) No useless RPC call'' --test ''Edo: (Proxy) (/chains/main/blocks/head/votes/current_proposal) No useless RPC call'' --test ''Edo: (Proxy) (/chains/main/blocks/head/context/delegates) Cache at most once'' --test ''Alpha: (Proxy) (/chains/main/blocks/head/context/nonces/3) Cache at most once'' --test ''Edo: (Proxy) (/chains/main/blocks/head/minimal_valid_time) Cache at most once'' --test ''Edo: (Proxy) (/chains/main/blocks/head/votes/successor_period) No useless RPC call'' --test ''Edo: (Proxy) (/chains/main/blocks/head/context/nonces/3) No useless RPC call'' --test ''Edo: (Proxy) (/chains/main/blocks/head/context/constants/errors) Cache at most once'' --test ''Edo: (Proxy) (/chains/main/blocks/head/votes/proposals) No useless RPC call'' --test ''Edo: (Proxy) (/chains/main/blocks/head/votes/current_quorum) Cache at most once'' --test ''Edo: (Proxy) (/chains/main/blocks/head/helpers/levels_in_current_cycle) Cache at most once'' --test ''Alpha: (Proxy) (/chains/main/blocks/head/votes/ballot_list) Cache at most once'' --test ''Alpha: (Proxy) (/chains/main/blocks/head/context/constants) Cache at most once'' --test ''Alpha: (Proxy) (/chains/main/blocks/head/votes/current_period) No useless RPC call'' --test ''Alpha: (Proxy) (/chains/main/blocks/head/helpers/baking_rights?all=true) No useless RPC call'' --test ''Edo: (Proxy) (/chains/main/blocks/head/votes/ballots) No useless RPC call'' --test ''Alpha: (Proxy) (/chains/main/blocks/head/votes/total_voting_power) No useless RPC call'' --test ''Alpha: (Proxy) (/chains/main/blocks/head/votes/total_voting_power) Cache at most once'' --test ''Edo: current encoding regression test: operation'' --test ''Alpha: (Proxy) (/chains/main/blocks/head/votes/ballot_list) No useless RPC call'' --test ''Edo: (Proxy) (/chains/main/blocks/head/votes/total_voting_power) No useless RPC call'' --test ''Edo: (Proxy) (/chains/main/blocks/head/helpers/baking_rights) No useless RPC call'' --test ''Alpha: (Proxy) (/chains/main/blocks/head/helpers/baking_rights?all=true) Cache at most once'' --test ''Alpha: alpha (mode proxy) RPC regression tests: others'' --test ''Alpha: (Proxy) (/chains/main/blocks/head/votes/listings) No useless RPC call'' --test ''Edo: current (mode proxy) RPC regression tests: others'' --test ''Alpha: (Proxy) RPC get''\''''s location'' --test ''Alpha: node initialization (archive mode)'' --test ''Alpha: check --connection=1 option'' --test ''Edo: (Proxy) Transfer'' --test ''Edo: current (mode proxy) RPC regression tests: delegates'' --test ''Alpha: Check prevalidator start'' --test ''Alpha: alpha (mode proxy) RPC regression tests: votes'' --test p2p-maintenance-init-expected_connections --test ''Alpha: (Proxy) Compare RPC get'' --test ''Alpha: alpha (mode client) RPC regression tests: contracts'' --test ''Alpha: double baking with accuser'' --test ''Edo: (Mockup) Multi transfer/multi baking (asynchronous)'' --test ''Alpha: node synchronization (rolling / archive)'' --test ''Alpha: node synchronization (full / archive)'' --test ''Alpha: node synchronization (archive / rolling)'' # 304.513179541s'

tezt:3:
  extends: .tezt_template
  script:
    - 'dune exec tezt/tests/main.exe -- --color --log-buffer-size 5000 --log-file tezt.log --global-timeout 3300 --time --not-test ''Alpha: node synchronization (archive / rolling)'' --not-test ''Alpha: node synchronization (full / archive)'' --not-test ''Alpha: node synchronization (rolling / archive)'' --not-test ''Edo: (Mockup) Multi transfer/multi baking (asynchronous)'' --not-test ''Alpha: double baking with accuser'' --not-test ''Alpha: alpha (mode client) RPC regression tests: contracts'' --not-test ''Alpha: (Proxy) Compare RPC get'' --not-test p2p-maintenance-init-expected_connections --not-test ''Alpha: alpha (mode proxy) RPC regression tests: votes'' --not-test ''Alpha: Check prevalidator start'' --not-test ''Edo: current (mode proxy) RPC regression tests: delegates'' --not-test ''Edo: (Proxy) Transfer'' --not-test ''Alpha: check --connection=1 option'' --not-test ''Alpha: node initialization (archive mode)'' --not-test ''Alpha: (Proxy) RPC get''\''''s location'' --not-test ''Edo: current (mode proxy) RPC regression tests: others'' --not-test ''Alpha: (Proxy) (/chains/main/blocks/head/votes/listings) No useless RPC call'' --not-test ''Alpha: alpha (mode proxy) RPC regression tests: others'' --not-test ''Alpha: (Proxy) (/chains/main/blocks/head/helpers/baking_rights?all=true) Cache at most once'' --not-test ''Edo: (Proxy) (/chains/main/blocks/head/helpers/baking_rights) No useless RPC call'' --not-test ''Edo: (Proxy) (/chains/main/blocks/head/votes/total_voting_power) No useless RPC call'' --not-test ''Alpha: (Proxy) (/chains/main/blocks/head/votes/ballot_list) No useless RPC call'' --not-test ''Edo: current encoding regression test: operation'' --not-test ''Alpha: (Proxy) (/chains/main/blocks/head/votes/total_voting_power) Cache at most once'' --not-test ''Alpha: (Proxy) (/chains/main/blocks/head/votes/total_voting_power) No useless RPC call'' --not-test ''Edo: (Proxy) (/chains/main/blocks/head/votes/ballots) No useless RPC call'' --not-test ''Alpha: (Proxy) (/chains/main/blocks/head/helpers/baking_rights?all=true) No useless RPC call'' --not-test ''Alpha: (Proxy) (/chains/main/blocks/head/votes/current_period) No useless RPC call'' --not-test ''Alpha: (Proxy) (/chains/main/blocks/head/context/constants) Cache at most once'' --not-test ''Alpha: (Proxy) (/chains/main/blocks/head/votes/ballot_list) Cache at most once'' --not-test ''Edo: (Proxy) (/chains/main/blocks/head/helpers/levels_in_current_cycle) Cache at most once'' --not-test ''Edo: (Proxy) (/chains/main/blocks/head/votes/current_quorum) Cache at most once'' --not-test ''Edo: (Proxy) (/chains/main/blocks/head/votes/proposals) No useless RPC call'' --not-test ''Edo: (Proxy) (/chains/main/blocks/head/context/constants/errors) Cache at most once'' --not-test ''Edo: (Proxy) (/chains/main/blocks/head/context/nonces/3) No useless RPC call'' --not-test ''Edo: (Proxy) (/chains/main/blocks/head/votes/successor_period) No useless RPC call'' --not-test ''Edo: (Proxy) (/chains/main/blocks/head/minimal_valid_time) Cache at most once'' --not-test ''Alpha: (Proxy) (/chains/main/blocks/head/context/nonces/3) Cache at most once'' --not-test ''Edo: (Proxy) (/chains/main/blocks/head/context/delegates) Cache at most once'' --not-test ''Edo: (Proxy) (/chains/main/blocks/head/votes/current_proposal) No useless RPC call'' --not-test ''Edo: (Proxy) (/chains/main/blocks/head/votes/current_period_kind) No useless RPC call'' --not-test ''Alpha: (Proxy) (/chains/main/blocks/head/helpers/current_level) Cache at most once'' --not-test ''Alpha: (Mockup) Transfer'' --not-test ''Edo: (Mockup) Transfer'' --not-test ''CLI under connections cap'' --not-test ''Alpha: alpha encoding regression test: operation.internal'' --not-test ''Alpha: (Mockup) Transfer (asynchronous)'' --not-test ''Edo: current encoding regression test: delegate.balance_updates'' --not-test ''Alpha: alpha encoding regression test: contract.big_map_diff'' --not-test ''Edo: current encoding regression test: voting_period.kind'' --not-test ''Alpha: alpha encoding regression test: vote.ballot'' --not-test ''Alpha: (Mockup) RPC header/shell'' --not-test ''Alpha: alpha encoding regression test: contract'' --not-test ''Alpha: alpha encoding regression test: gas.cost'' --not-test ''Alpha: alpha encoding regression test: tez'' --not-test ''Alpha: alpha encoding regression test: raw_level'' --not-test ''Alpha: alpha encoding regression test: cycle'' --not-test ''Edo: current encoding regression test: contract'' --not-test ''Edo: current encoding regression test: timestamp'' --not-test ''Alpha: alpha encoding regression test: block_header.raw'' --not-test ''Edo: current encoding regression test: vote.ballots'' --not-test ''Alpha: alpha encoding regression test: block_header'' --not-test ''Alpha: alpha encoding regression test: vote.ballots'' --not-test ''Alpha: alpha encoding regression test: fitness'' --not-test ''Edo: current encoding regression test: nonce'' --not-test ''Alpha: alpha encoding regression test: delegate.frozen_balance'' --not-test ''Alpha: node synchronization (full / full)'' --not-test ''Alpha: node synchronization (archive / archive)'' --not-test ''Alpha: node synchronization (rolling / full)'' --not-test ''Alpha: (Mockup) Multi transfer/multi baking (asynchronous)'' --not-test ''Alpha: alpha (mode proxy) RPC regression tests: contracts'' --not-test ''tezos-codec dump encodings'' --not-test ''Edo: (Proxy) Compare RPC get'' --not-test ''Alpha: baking ordering'' --not-test ''Edo: current (mode client) RPC regression tests: votes'' --not-test ''Alpha: alpha (mode proxy) RPC regression tests: delegates'' --not-test ''Alpha: alpha (mode client) RPC regression tests: delegates'' --not-test ''Edo: (Proxy) Bake'' --not-test ''Alpha: node initialization (full mode)'' --not-test ''Alpha: (Proxy) (/chains/main/blocks/head/votes/proposals) No useless RPC call'' --not-test ''Alpha: alpha encoding regression test: operation'' --not-test ''Alpha: alpha (mode client) RPC regression tests: others'' --not-test ''Edo: (Proxy) (/chains/main/blocks/head/helpers/baking_rights) Cache at most once'' --not-test ''Alpha: (Proxy) (/chains/main/blocks/head/votes/listings) Cache at most once'' --not-test ''Edo: (Proxy) (/chains/main/blocks/head/votes/ballots) Cache at most once'' --not-test ''Alpha: (Proxy) (/chains/main/blocks/head/context/delegates) No useless RPC call'' --not-test ''Edo: (Proxy) (/chains/main/blocks/head/helpers/baking_rights?all=true) No useless RPC call'' --not-test ''Alpha: (Proxy) (/chains/main/blocks/head/votes/successor_period) Cache at most once'' --not-test ''Edo: current encoding regression test: operation.unsigned'' --not-test ''Edo: (Proxy) (/chains/main/blocks/head/votes/ballot_list) Cache at most once'' --not-test ''Alpha: (Proxy) (/chains/main/blocks/head/votes/ballots) Cache at most once'' --not-test ''Edo: (Proxy) (/chains/main/blocks/head/votes/listings) Cache at most once'' --not-test ''Edo: (Proxy) (/chains/main/blocks/head/votes/ballot_list) No useless RPC call'' --not-test ''Alpha: (Proxy) (/chains/main/blocks/head/helpers/baking_rights) No useless RPC call'' --not-test ''Edo: (Proxy) Wrong proto'' --not-test ''Alpha: (Proxy) (/chains/main/blocks/head/votes/current_period) Cache at most once'' --not-test ''Alpha: normalize data'' --not-test ''Alpha: (Proxy) (/chains/main/blocks/head/minimal_valid_time) Cache at most once'' --not-test ''Edo: (Proxy) (/chains/main/blocks/head/votes/successor_period) Cache at most once'' --not-test ''Edo: (Proxy) (/chains/main/blocks/head/votes/listings) No useless RPC call'' --not-test ''Alpha: (Proxy) (/chains/main/blocks/head/votes/ballots) No useless RPC call'' --not-test ''Alpha: (Proxy) (/chains/main/blocks/head/votes/proposals) Cache at most once'' --not-test ''Alpha: (Proxy) (/chains/main/blocks/head/votes/current_proposal) Cache at most once'' --not-test ''Alpha: (Proxy) (/chains/main/blocks/head/votes/successor_period) No useless RPC call'' --not-test ''Alpha: (Proxy) (/chains/main/blocks/head/context/delegates) Cache at most once'' --not-test ''(Mockup) Migration (transfer)'' --not-test ''Edo: (Proxy) (/chains/main/blocks/head/context/nonces/3) Cache at most once'' --not-test ''Edo: (Proxy) (/chains/main/blocks/head/helpers/current_level) Cache at most once'' --not-test ''Alpha: hash data ... of type ... (bad)'' --not-test ''Alpha: alpha encoding regression test: receipt.balance_updates'' --not-test ''Alpha: (Mockup) origination fees from unrevealed'' --not-test ''Edo: current encoding regression test: operation.internal'' --not-test ''Alpha: normalize data (mockup)'' --not-test ''Edo: (Mockup) Transfer same participants (asynchronous)'' --not-test ''Alpha: (Mockup) Transfer same participants (asynchronous)'' --not-test ''Alpha: alpha encoding regression test: voting_period.kind'' --not-test ''Alpha: alpha encoding regression test: gas'' --not-test ''Edo: current encoding regression test: vote.ballot'' --not-test ''Alpha: alpha encoding regression test: period'' --not-test ''Edo: current encoding regression test: voting_period'' --not-test ''Edo: current encoding regression test: gas.cost'' --not-test ''Edo: current encoding regression test: cycle'' --not-test ''Edo: current encoding regression test: period'' --not-test ''Alpha: alpha encoding regression test: nonce'' --not-test ''Edo: current encoding regression test: block_header.raw'' --not-test ''Edo: current encoding regression test: block_header'' --not-test ''Edo: current encoding regression test: fitness'' --not-test ''Alpha: alpha encoding regression test: timestamp'' --not-test ''Edo: current encoding regression test: seed'' --not-test ''Alpha: alpha encoding regression test: seed'' --not-test ''Alpha: alpha encoding regression test: operation.raw'' --not-test ''Alpha: alpha encoding regression test: level'' --not-test ''Edo: current encoding regression test: level'' # 304.424400091s'
##END_TEZTTEST##

tezt:manual:migration:
  extends: .test_template
  when: manual
  before_script:
    - export TEZOS_CLIENT_UNSAFE_DISABLE_DISCLAIMER=Y
    - curl -s https://api.github.com/repos/Phlogi/tezos-snapshots/releases/latest | jq -r ".assets[] | select(.name) | .browser_download_url" | grep roll | xargs wget -q
    - block_hash=$(echo mainnet.roll.* | sed -r 's/mainnet\.roll\.[0-9_-]+\.(.*)\.[0-9]+\.chain\.xz/\1/g')
    - cat mainnet.roll.* | xz -d -v -T0 > mainnet.rolling

    - scripts/prepare_migration_test.sh auto mainnet.rolling "$block_hash"
  script:
    - if [ ! -f tezos-node ] || [ ! -f tezos-client ] || [ ! -f tezos-codec ] || [ ! -f tezos-sandbox ]; then make; fi
    - dune exec ./tezt/manual_tests/main.exe -- migration --color --log-buffer-size 5000 --log-file tezt-migration.log
  artifacts:
    when: always
    paths:
      - tezt-migration.log
    expire_in: 30 days

