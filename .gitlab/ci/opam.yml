---

.opam_template:
  extends: .runtime_build_test_dependencies_template
  stage: packaging
  dependencies: []
  rules:
    - if: '$CI_COMMIT_TAG && $CI_PROJECT_NAMESPACE == "tezos"'
      when: never
    - if: '$CI_COMMIT_BRANCH =~ /-release$/ && $CI_PROJECT_NAMESPACE == "tezos"'
      when: never
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: on_success
    - if: '$CI_COMMIT_BRANCH == "proto-proposal"'
      when: on_success
    - if: '$CI_COMMIT_BRANCH =~ /opam/'
      when: on_success
    - changes:
        - /**/*.opam
        - /**/dune
        - /**/dune.inc
        - /**/*.dune.inc
        - /scripts/version.sh
        - /.gitlab-ci.yml
      when: on_success
  interruptible: true

##BEGIN_OPAM##

opam:tests:group0:
  extends: .opam_template
  needs:
    - check_opam_lint
    - check_opam_deps
  script:
    - ./scripts/opam-pin.sh
    - scripts/test_wrapper.sh opam benchmark-utils
    - scripts/test_wrapper.sh opam bls12-381
    - scripts/test_wrapper.sh opam flextesa
    - scripts/test_wrapper.sh opam latex
    - scripts/test_wrapper.sh opam ledgerwallet
    - scripts/test_wrapper.sh opam ledgerwallet-tezos
    - scripts/test_wrapper.sh opam numerics
    - scripts/test_wrapper.sh opam pyml-plot

opam:tests:group8:
  extends: .opam_template
  needs:
    - check_opam_lint
    - check_opam_deps
  script:
    - ./scripts/opam-pin.sh
    - scripts/test_wrapper.sh opam staTz
    - scripts/test_wrapper.sh opam tezos-007-PsDELPH1-test-helpers
    - scripts/test_wrapper.sh opam tezos-008-PtEdoTez-test-helpers
    - scripts/test_wrapper.sh opam tezos-accuser-007-PsDELPH1
    - scripts/test_wrapper.sh opam tezos-accuser-007-PsDELPH1-commands
    - scripts/test_wrapper.sh opam tezos-accuser-008-PtEdoTez
    - scripts/test_wrapper.sh opam tezos-accuser-008-PtEdoTez-commands
    - scripts/test_wrapper.sh opam tezos-accuser-alpha

opam:tests:group16:
  extends: .opam_template
  needs:
    - check_opam_lint
    - check_opam_deps
  script:
    - ./scripts/opam-pin.sh
    - scripts/test_wrapper.sh opam tezos-accuser-alpha-commands
    - scripts/test_wrapper.sh opam tezos-alpha-test-helpers
    - scripts/test_wrapper.sh opam tezos-baker-007-PsDELPH1
    - scripts/test_wrapper.sh opam tezos-baker-008-PtEdoTez
    - scripts/test_wrapper.sh opam tezos-baker-alpha
    - scripts/test_wrapper.sh opam tezos-baking-007-PsDELPH1
    - scripts/test_wrapper.sh opam tezos-baking-007-PsDELPH1-commands
    - scripts/test_wrapper.sh opam tezos-baking-008-PtEdoTez

opam:tests:group24:
  extends: .opam_template
  needs:
    - check_opam_lint
    - check_opam_deps
  script:
    - ./scripts/opam-pin.sh
    - scripts/test_wrapper.sh opam tezos-baking-008-PtEdoTez-commands
    - scripts/test_wrapper.sh opam tezos-baking-alpha
    - scripts/test_wrapper.sh opam tezos-baking-alpha-commands
    - scripts/test_wrapper.sh opam tezos-base
    - scripts/test_wrapper.sh opam tezos-benchmark
    - scripts/test_wrapper.sh opam tezos-benchmark-examples
    - scripts/test_wrapper.sh opam tezos-benchmark-tests
    - scripts/test_wrapper.sh opam tezos-clic

opam:tests:group32:
  extends: .opam_template
  needs:
    - check_opam_lint
    - check_opam_deps
  script:
    - ./scripts/opam-pin.sh
    - scripts/test_wrapper.sh opam tezos-client
    - scripts/test_wrapper.sh opam tezos-client-000-Ps9mPmXa
    - scripts/test_wrapper.sh opam tezos-client-001-PtCJ7pwo
    - scripts/test_wrapper.sh opam tezos-client-001-PtCJ7pwo-commands
    - scripts/test_wrapper.sh opam tezos-client-002-PsYLVpVv
    - scripts/test_wrapper.sh opam tezos-client-002-PsYLVpVv-commands
    - scripts/test_wrapper.sh opam tezos-client-003-PsddFKi3
    - scripts/test_wrapper.sh opam tezos-client-003-PsddFKi3-commands

opam:tests:group40:
  extends: .opam_template
  needs:
    - check_opam_lint
    - check_opam_deps
  script:
    - ./scripts/opam-pin.sh
    - scripts/test_wrapper.sh opam tezos-client-004-Pt24m4xi
    - scripts/test_wrapper.sh opam tezos-client-004-Pt24m4xi-commands
    - scripts/test_wrapper.sh opam tezos-client-005-PsBabyM1
    - scripts/test_wrapper.sh opam tezos-client-005-PsBabyM1-commands
    - scripts/test_wrapper.sh opam tezos-client-006-PsCARTHA
    - scripts/test_wrapper.sh opam tezos-client-006-PsCARTHA-commands
    - scripts/test_wrapper.sh opam tezos-client-007-PsDELPH1
    - scripts/test_wrapper.sh opam tezos-client-007-PsDELPH1-commands

opam:tests:group48:
  extends: .opam_template
  needs:
    - check_opam_lint
    - check_opam_deps
  script:
    - ./scripts/opam-pin.sh
    - scripts/test_wrapper.sh opam tezos-client-007-PsDELPH1-commands-registration
    - scripts/test_wrapper.sh opam tezos-client-008-PtEdoTez
    - scripts/test_wrapper.sh opam tezos-client-008-PtEdoTez-commands
    - scripts/test_wrapper.sh opam tezos-client-008-PtEdoTez-commands-registration
    - scripts/test_wrapper.sh opam tezos-client-alpha
    - scripts/test_wrapper.sh opam tezos-client-alpha-commands
    - scripts/test_wrapper.sh opam tezos-client-alpha-commands-registration
    - scripts/test_wrapper.sh opam tezos-client-base

opam:tests:group56:
  extends: .opam_template
  needs:
    - check_opam_lint
    - check_opam_deps
  script:
    - ./scripts/opam-pin.sh
    - scripts/test_wrapper.sh opam tezos-client-base-unix
    - scripts/test_wrapper.sh opam tezos-client-commands
    - scripts/test_wrapper.sh opam tezos-client-demo-counter
    - scripts/test_wrapper.sh opam tezos-client-genesis
    - scripts/test_wrapper.sh opam tezos-client-genesis-carthagenet
    - scripts/test_wrapper.sh opam tezos-client-sapling-008-PtEdoTez
    - scripts/test_wrapper.sh opam tezos-client-sapling-alpha
    - scripts/test_wrapper.sh opam tezos-codec

opam:tests:group64:
  extends: .opam_template
  needs:
    - check_opam_lint
    - check_opam_deps
  script:
    - ./scripts/opam-pin.sh
    - scripts/test_wrapper.sh opam tezos-crypto
    - scripts/test_wrapper.sh opam tezos-embedded-protocol-000-Ps9mPmXa
    - scripts/test_wrapper.sh opam tezos-embedded-protocol-001-PtCJ7pwo
    - scripts/test_wrapper.sh opam tezos-embedded-protocol-002-PsYLVpVv
    - scripts/test_wrapper.sh opam tezos-embedded-protocol-003-PsddFKi3
    - scripts/test_wrapper.sh opam tezos-embedded-protocol-004-Pt24m4xi
    - scripts/test_wrapper.sh opam tezos-embedded-protocol-005-PsBABY5H
    - scripts/test_wrapper.sh opam tezos-embedded-protocol-005-PsBabyM1

opam:tests:group72:
  extends: .opam_template
  needs:
    - check_opam_lint
    - check_opam_deps
  script:
    - ./scripts/opam-pin.sh
    - scripts/test_wrapper.sh opam tezos-embedded-protocol-006-PsCARTHA
    - scripts/test_wrapper.sh opam tezos-embedded-protocol-007-PsDELPH1
    - scripts/test_wrapper.sh opam tezos-embedded-protocol-008-PtEdoTez
    - scripts/test_wrapper.sh opam tezos-embedded-protocol-alpha
    - scripts/test_wrapper.sh opam tezos-embedded-protocol-demo-counter
    - scripts/test_wrapper.sh opam tezos-embedded-protocol-demo-noops
    - scripts/test_wrapper.sh opam tezos-embedded-protocol-genesis
    - scripts/test_wrapper.sh opam tezos-embedded-protocol-genesis-carthagenet

opam:tests:group80:
  extends: .opam_template
  needs:
    - check_opam_lint
    - check_opam_deps
  script:
    - ./scripts/opam-pin.sh
    - scripts/test_wrapper.sh opam tezos-endorser-007-PsDELPH1
    - scripts/test_wrapper.sh opam tezos-endorser-007-PsDELPH1-commands
    - scripts/test_wrapper.sh opam tezos-endorser-008-PtEdoTez
    - scripts/test_wrapper.sh opam tezos-endorser-008-PtEdoTez-commands
    - scripts/test_wrapper.sh opam tezos-endorser-alpha
    - scripts/test_wrapper.sh opam tezos-endorser-alpha-commands
    - scripts/test_wrapper.sh opam tezos-error-monad
    - scripts/test_wrapper.sh opam tezos-event-logging

opam:tests:group88:
  extends: .opam_template
  needs:
    - check_opam_lint
    - check_opam_deps
  script:
    - ./scripts/opam-pin.sh
    - scripts/test_wrapper.sh opam tezos-lmdb
    - scripts/test_wrapper.sh opam tezos-lwt-result-stdlib
    - scripts/test_wrapper.sh opam tezos-mempool-007-PsDELPH1
    - scripts/test_wrapper.sh opam tezos-mempool-008-PtEdoTez
    - scripts/test_wrapper.sh opam tezos-mempool-alpha
    - scripts/test_wrapper.sh opam tezos-micheline
    - scripts/test_wrapper.sh opam tezos-micheline-rewriting
    - scripts/test_wrapper.sh opam tezos-mockup

opam:tests:group96:
  extends: .opam_template
  needs:
    - check_opam_lint
    - check_opam_deps
  script:
    - ./scripts/opam-pin.sh
    - scripts/test_wrapper.sh opam tezos-mockup-commands
    - scripts/test_wrapper.sh opam tezos-mockup-proxy
    - scripts/test_wrapper.sh opam tezos-mockup-registration
    - scripts/test_wrapper.sh opam tezos-node
    - scripts/test_wrapper.sh opam tezos-p2p
    - scripts/test_wrapper.sh opam tezos-p2p-services
    - scripts/test_wrapper.sh opam tezos-protocol-000-Ps9mPmXa
    - scripts/test_wrapper.sh opam tezos-protocol-001-PtCJ7pwo

opam:tests:group104:
  extends: .opam_template
  needs:
    - check_opam_lint
    - check_opam_deps
  script:
    - ./scripts/opam-pin.sh
    - scripts/test_wrapper.sh opam tezos-protocol-002-PsYLVpVv
    - scripts/test_wrapper.sh opam tezos-protocol-003-PsddFKi3
    - scripts/test_wrapper.sh opam tezos-protocol-004-Pt24m4xi
    - scripts/test_wrapper.sh opam tezos-protocol-005-PsBABY5H
    - scripts/test_wrapper.sh opam tezos-protocol-005-PsBabyM1
    - scripts/test_wrapper.sh opam tezos-protocol-006-PsCARTHA
    - scripts/test_wrapper.sh opam tezos-protocol-006-PsCARTHA-parameters
    - scripts/test_wrapper.sh opam tezos-protocol-007-PsDELPH1

opam:tests:group112:
  extends: .opam_template
  needs:
    - check_opam_lint
    - check_opam_deps
  script:
    - ./scripts/opam-pin.sh
    - scripts/test_wrapper.sh opam tezos-protocol-007-PsDELPH1-parameters
    - scripts/test_wrapper.sh opam tezos-protocol-007-PsDELPH1-tests
    - scripts/test_wrapper.sh opam tezos-protocol-008-PtEdoTez
    - scripts/test_wrapper.sh opam tezos-protocol-008-PtEdoTez-parameters
    - scripts/test_wrapper.sh opam tezos-protocol-008-PtEdoTez-tests
    - scripts/test_wrapper.sh opam tezos-protocol-alpha
    - scripts/test_wrapper.sh opam tezos-protocol-alpha-parameters
    - scripts/test_wrapper.sh opam tezos-protocol-alpha-tests

opam:tests:group120:
  extends: .opam_template
  needs:
    - check_opam_lint
    - check_opam_deps
  script:
    - ./scripts/opam-pin.sh
    - scripts/test_wrapper.sh opam tezos-protocol-compiler
    - scripts/test_wrapper.sh opam tezos-protocol-demo-counter
    - scripts/test_wrapper.sh opam tezos-protocol-demo-noops
    - scripts/test_wrapper.sh opam tezos-protocol-environment
    - scripts/test_wrapper.sh opam tezos-protocol-environment-packer
    - scripts/test_wrapper.sh opam tezos-protocol-environment-sigs
    - scripts/test_wrapper.sh opam tezos-protocol-environment-structs
    - scripts/test_wrapper.sh opam tezos-protocol-functor-000-Ps9mPmXa

opam:tests:group128:
  extends: .opam_template
  needs:
    - check_opam_lint
    - check_opam_deps
  script:
    - ./scripts/opam-pin.sh
    - scripts/test_wrapper.sh opam tezos-protocol-functor-001-PtCJ7pwo
    - scripts/test_wrapper.sh opam tezos-protocol-functor-002-PsYLVpVv
    - scripts/test_wrapper.sh opam tezos-protocol-functor-003-PsddFKi3
    - scripts/test_wrapper.sh opam tezos-protocol-functor-004-Pt24m4xi
    - scripts/test_wrapper.sh opam tezos-protocol-functor-005-PsBABY5H
    - scripts/test_wrapper.sh opam tezos-protocol-functor-005-PsBabyM1
    - scripts/test_wrapper.sh opam tezos-protocol-functor-006-PsCARTHA
    - scripts/test_wrapper.sh opam tezos-protocol-functor-007-PsDELPH1

opam:tests:group136:
  extends: .opam_template
  needs:
    - check_opam_lint
    - check_opam_deps
  script:
    - ./scripts/opam-pin.sh
    - scripts/test_wrapper.sh opam tezos-protocol-functor-008-PtEdoTez
    - scripts/test_wrapper.sh opam tezos-protocol-functor-alpha
    - scripts/test_wrapper.sh opam tezos-protocol-functor-demo-counter
    - scripts/test_wrapper.sh opam tezos-protocol-functor-demo-noops
    - scripts/test_wrapper.sh opam tezos-protocol-functor-genesis
    - scripts/test_wrapper.sh opam tezos-protocol-functor-genesis-carthagenet
    - scripts/test_wrapper.sh opam tezos-protocol-genesis
    - scripts/test_wrapper.sh opam tezos-protocol-genesis-carthagenet

opam:tests:group144:
  extends: .opam_template
  needs:
    - check_opam_lint
    - check_opam_deps
  script:
    - ./scripts/opam-pin.sh
    - scripts/test_wrapper.sh opam tezos-protocol-updater
    - scripts/test_wrapper.sh opam tezos-proxy
    - scripts/test_wrapper.sh opam tezos-requester
    - scripts/test_wrapper.sh opam tezos-rpc
    - scripts/test_wrapper.sh opam tezos-rpc-http
    - scripts/test_wrapper.sh opam tezos-rpc-http-client
    - scripts/test_wrapper.sh opam tezos-rpc-http-client-unix
    - scripts/test_wrapper.sh opam tezos-rpc-http-server

opam:tests:group152:
  extends: .opam_template
  needs:
    - check_opam_lint
    - check_opam_deps
  script:
    - ./scripts/opam-pin.sh
    - scripts/test_wrapper.sh opam tezos-sapling
    - scripts/test_wrapper.sh opam tezos-shell
    - scripts/test_wrapper.sh opam tezos-shell-benchmarks
    - scripts/test_wrapper.sh opam tezos-shell-context
    - scripts/test_wrapper.sh opam tezos-shell-services
    - scripts/test_wrapper.sh opam tezos-signer
    - scripts/test_wrapper.sh opam tezos-signer-backends
    - scripts/test_wrapper.sh opam tezos-signer-services

opam:tests:group160:
  extends: .opam_template
  needs:
    - check_opam_lint
    - check_opam_deps
  script:
    - ./scripts/opam-pin.sh
    - scripts/test_wrapper.sh opam tezos-snoop
    - scripts/test_wrapper.sh opam tezos-stdlib
    - scripts/test_wrapper.sh opam tezos-stdlib-unix
    - scripts/test_wrapper.sh opam tezos-storage
    - scripts/test_wrapper.sh opam tezos-test-services
    - scripts/test_wrapper.sh opam tezos-tooling
    - scripts/test_wrapper.sh opam tezos-validation
    - scripts/test_wrapper.sh opam tezos-validator

opam:tests:group168:
  extends: .opam_template
  needs:
    - check_opam_lint
    - check_opam_deps
  script:
    - ./scripts/opam-pin.sh
    - scripts/test_wrapper.sh opam tezos-version
    - scripts/test_wrapper.sh opam tezos-workers
    - scripts/test_wrapper.sh opam uecc
##END_OPAM##
